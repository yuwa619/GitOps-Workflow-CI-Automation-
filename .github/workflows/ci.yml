name: CI

on:
  push:
    branches:
      - main
      - "feature/**"
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review, closed]

permissions:
  contents: read

jobs:
  # ‚îÄ‚îÄ 1. Card lifecycle on PR open / synchronize / reopen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  trello-in-progress:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      (
        github.event.action == 'opened' ||
        github.event.action == 'synchronize' ||
        github.event.action == 'reopened' ||
        github.event.action == 'ready_for_review'
      )
    steps:
      - name: Create card (if missing) and move to In Progress
        env:
          TRELLO_KEY:        ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN:      ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID:   ${{ secrets.TRELLO_BOARD_ID }}
          LIST_BACKLOG:      ${{ secrets.TRELLO_LIST_BACKLOG }}
          LIST_IN_PROGRESS:  ${{ secrets.TRELLO_LIST_IN_PROGRESS }}
          PR_TITLE:          ${{ github.event.pull_request.title }}
          PR_URL:            ${{ github.event.pull_request.html_url }}
          PR_NUMBER:         ${{ github.event.pull_request.number }}
          REPO:              ${{ github.repository }}
          EVENT_ACTION:      ${{ github.event.action }}
          COMMIT_SHA:        ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "
          import os,sys,json
          pr=os.environ['PR_URL']
          cards=json.load(sys.stdin)
          print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))
          ")"

          if [ -z "$CARD_ID" ]; then
            NEXT_NUM="$(echo "$CARDS_JSON" | python3 -c "
          import sys,json,re
          cards=json.load(sys.stdin)
          nums=[int(m.group(1)) for c in cards for m in [re.search(r'TRELLO-(\d+)',c.get('name',''))] if m]
          print(max(nums,default=0)+1)
            ")"

            TID="TRELLO-$(printf '%03d' "$NEXT_NUM")"

            # Strip any existing TRELLO-XXX prefix from the PR title to avoid double prefixing
            CLEAN_TITLE="$(echo "$PR_TITLE" | python3 -c "
          import sys,re
          t=sys.stdin.read().strip()
          t=re.sub(r'^TRELLO-\d+\s*[-‚Äì]\s*','',t,flags=re.IGNORECASE)
          print(t)
            ")"

            CARD_NAME="${TID} - ${CLEAN_TITLE}"
            CARD_DESC="Auto-created by GitHub Actions.\nPR: ${PR_URL}\nRepo: ${REPO}\nPR#: ${PR_NUMBER}"

            # Create in Backlog first
            CARD_ID="$(curl -sS -X POST \
              --data-urlencode "idList=${LIST_BACKLOG}" \
              --data-urlencode "name=${CARD_NAME}" \
              --data-urlencode "desc=${CARD_DESC}" \
              "https://api.trello.com/1/cards?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
              | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")"
            echo "Created Trello card: $CARD_NAME ($CARD_ID)"
          else
            echo "Found existing card: $CARD_ID"
          fi

          # Move to In Progress
          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_IN_PROGRESS}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Moved card to In Progress."

          # Post an In Progress comment
          EVENT_DATE="$(date -u '+%Y-%m-%d %H:%M UTC')"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          if [ "$EVENT_ACTION" = "opened" ]; then
            TRIGGER="PR #${PR_NUMBER} opened"
          elif [ "$EVENT_ACTION" = "synchronize" ]; then
            TRIGGER="new commit pushed (${SHORT_SHA})"
          else
            TRIGGER="PR ${EVENT_ACTION}"
          fi
          COMMENT="üîÑ *Moved to In Progress on ${EVENT_DATE}*\n\n**Trigger:** ${TRIGGER}\n**PR:** [#${PR_NUMBER}](${PR_URL})\n**Repo:** ${REPO}"

          curl -sS -X POST \
            --data-urlencode "text=${COMMENT}" \
            "https://api.trello.com/1/cards/${CARD_ID}/actions/comments?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Posted In Progress comment."

  # ‚îÄ‚îÄ 2. Build & test ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-test:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint
        run: flake8 app.py test_app.py

      - name: Test
        run: pytest test_app.py -v

  # ‚îÄ‚îÄ 3. CI passed ‚Üí Review/QA + comment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  trello-review-qa:
    needs: build-test
    runs-on: ubuntu-latest
    if: >
      success() &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    steps:
      - name: Move card to Review/QA and post CI passed comment
        env:
          TRELLO_KEY:      ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN:    ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          LIST_REVIEW_QA:  ${{ secrets.TRELLO_LIST_REVIEW_QA }}
          PR_URL:          ${{ github.event.pull_request.html_url }}
          PR_NUMBER:       ${{ github.event.pull_request.number }}
          COMMIT_SHA:      ${{ github.event.pull_request.head.sha }}
          REPO:            ${{ github.repository }}
          RUN_URL:         ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "
          import os,sys,json
          pr=os.environ['PR_URL']
          cards=json.load(sys.stdin)
          print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))
          ")"

          if [ -z "$CARD_ID" ]; then
            echo "No card found for this PR ‚Äî skipping."
            exit 0
          fi

          # Move to Review/QA
          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_REVIEW_QA}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Moved card to Review/QA."

          # Post a comment explaining why it left In Progress
          EVENT_DATE="$(date -u '+%Y-%m-%d %H:%M UTC')"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMENT="‚úÖ *Moved to Review/QA on ${EVENT_DATE}*\n\n**Reason:** All CI checks passed\n**Commit:** \`${SHORT_SHA}\`\n**CI Run:** [View run](${RUN_URL})\n**PR:** [#${PR_NUMBER}](${PR_URL})"

          curl -sS -X POST \
            --data-urlencode "text=${COMMENT}" \
            "https://api.trello.com/1/cards/${CARD_ID}/actions/comments?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Posted Review/QA comment."

  # ‚îÄ‚îÄ 4. CI failed ‚Üí back to In Progress + red label + comment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  trello-ci-failed:
    needs: build-test
    runs-on: ubuntu-latest
    if: >
      failure() &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    steps:
      - name: Move card back to In Progress, add red label, post failure comment
        env:
          TRELLO_KEY:       ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN:     ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID:  ${{ secrets.TRELLO_BOARD_ID }}
          LIST_IN_PROGRESS: ${{ secrets.TRELLO_LIST_IN_PROGRESS }}
          PR_URL:           ${{ github.event.pull_request.html_url }}
          PR_NUMBER:        ${{ github.event.pull_request.number }}
          COMMIT_SHA:       ${{ github.event.pull_request.head.sha }}
          RUN_URL:          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc,idLabels&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "
          import os,sys,json
          pr=os.environ['PR_URL']
          cards=json.load(sys.stdin)
          print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))
          ")"
          export CARD_ID

          if [ -z "$CARD_ID" ]; then
            echo "No card found for this PR ‚Äî skipping."
            exit 0
          fi

          # 1. Move card back to In Progress
          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_IN_PROGRESS}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Moved card back to In Progress (CI failed)."

          # 2. Find or create red "‚ùå CI Failed" label and apply it
          python3 - <<PYEOF
import os, json, urllib.request, urllib.parse

key   = os.environ['TRELLO_KEY']
token = os.environ['TRELLO_TOKEN']
board = os.environ['TRELLO_BOARD_ID']
card  = os.environ['CARD_ID']

def api(method, path, data=None):
    url = f"https://api.trello.com/1{path}?key={key}&token={token}"
    body = urllib.parse.urlencode(data).encode() if data else None
    req  = urllib.request.Request(url, data=body, method=method)
    with urllib.request.urlopen(req) as r:
        return json.loads(r.read())

# Find existing red CI-failed label
labels = api('GET', f'/boards/{board}/labels')
label_id = next((l['id'] for l in labels
                 if l.get('color') == 'red' and l.get('name') == '‚ùå CI Failed'), None)

if not label_id:
    resp = api('POST', '/labels',
               {'name': '‚ùå CI Failed', 'color': 'red', 'idBoard': board})
    label_id = resp['id']
    print(f"Created red label: {label_id}")
else:
    print(f"Found existing red label: {label_id}")

# Apply to card (ignore 'already exists' error)
try:
    api('POST', f'/cards/{card}/idLabels', {'value': label_id})
    print("Applied red label to card.")
except Exception as e:
    print(f"Label already on card or error: {e}")
PYEOF

          # 4. Post CI failure comment
          EVENT_DATE="$(date -u '+%Y-%m-%d %H:%M UTC')"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMENT="‚ùå *Moved back to In Progress on ${EVENT_DATE}*\n\n**Reason:** CI checks failed on commit \`${SHORT_SHA}\`\n**CI Run:** [View failed run](${RUN_URL})\n**PR:** [#${PR_NUMBER}](${PR_URL})"

          curl -sS -X POST \
            --data-urlencode "text=${COMMENT}" \
            "https://api.trello.com/1/cards/${CARD_ID}/actions/comments?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Posted CI failure comment."

  # ‚îÄ‚îÄ 5. PR merged ‚Üí Done + green label + merge comment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  trello-done:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    steps:
      - name: Move card to Done, add green label and merge comment
        env:
          TRELLO_KEY:      ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN:    ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          LIST_DONE:       ${{ secrets.TRELLO_LIST_DONE }}
          PR_URL:          ${{ github.event.pull_request.html_url }}
          PR_NUMBER:       ${{ github.event.pull_request.number }}
          PR_TITLE:        ${{ github.event.pull_request.title }}
          MERGED_BY:       ${{ github.event.pull_request.merged_by.login }}
          REPO:            ${{ github.repository }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "
          import os,sys,json
          pr=os.environ['PR_URL']
          cards=json.load(sys.stdin)
          print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))
          ")"
          export CARD_ID

          if [ -z "$CARD_ID" ]; then
            echo "No card found for this PR ‚Äî skipping."
            exit 0
          fi

          # 1. Move card to Done
          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_DONE}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Moved card to Done."

          # 2. Find/create green label, remove red label, apply green label
          python3 - <<PYEOF
import os, json, urllib.request, urllib.parse

key   = os.environ['TRELLO_KEY']
token = os.environ['TRELLO_TOKEN']
board = os.environ['TRELLO_BOARD_ID']
card  = os.environ['CARD_ID']

def api(method, path, data=None):
    url  = f"https://api.trello.com/1{path}?key={key}&token={token}"
    body = urllib.parse.urlencode(data).encode() if data else None
    req  = urllib.request.Request(url, data=body, method=method)
    with urllib.request.urlopen(req) as r:
        return json.loads(r.read())

labels = api('GET', f'/boards/{board}/labels')

# Find or create green label
green_id = next((l['id'] for l in labels
                 if l.get('color') == 'green' and l.get('name') == '‚úÖ Completed'), None)
if not green_id:
    resp     = api('POST', '/labels',
                   {'name': '‚úÖ Completed', 'color': 'green', 'idBoard': board})
    green_id = resp['id']
    print(f"Created green label: {green_id}")
else:
    print(f"Found existing green label: {green_id}")

# Remove red CI-failed label from card if present
red_id = next((l['id'] for l in labels
               if l.get('color') == 'red' and l.get('name') == '‚ùå CI Failed'), None)
if red_id:
    try:
        api('DELETE', f'/cards/{card}/idLabels/{red_id}')
        print("Removed red CI Failed label.")
    except Exception as e:
        print(f"Red label not on card or already removed: {e}")

# Apply green label
try:
    api('POST', f'/cards/{card}/idLabels', {'value': green_id})
    print("Applied green label to card.")
except Exception as e:
    print(f"Green label already on card or error: {e}")
PYEOF

          # 4. Post a merge comment on the card
          MERGE_DATE="$(date -u '+%Y-%m-%d %H:%M UTC')"
          COMMENT="‚úÖ *Merged on ${MERGE_DATE}*\n\n**PR:** [#${PR_NUMBER} - ${PR_TITLE}](${PR_URL})\n**Merged by:** @${MERGED_BY}\n**Repo:** ${REPO}"

          curl -sS -X POST \
            --data-urlencode "text=${COMMENT}" \
            "https://api.trello.com/1/cards/${CARD_ID}/actions/comments?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Posted merge comment on card."
