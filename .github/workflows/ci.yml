name: CI

on:
  push:
    branches:
      - main
      - "feature/**"
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint
        run: |
          flake8 app.py test_app.py

      - name: Test
        run: |
          pytest test_app.py -v

  trello:
    needs: build-test
    runs-on: ubuntu-latest
    if: ${{ success() && github.event_name == 'pull_request' }}
    steps:
      - name: Create Trello card if missing, then move to Review/QA
        env:
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          LIST_BACKLOG: ${{ secrets.TRELLO_LIST_BACKLOG }}
          LIST_REVIEW_QA: ${{ secrets.TRELLO_LIST_REVIEW_QA }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "import os,sys,json; pr=os.environ['PR_URL']; cards=json.load(sys.stdin); print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))")"
          CARD_ID="${CARD_ID:-}"

          if [ -z "$CARD_ID" ]; then
            NEXT_NUM="$(echo "$CARDS_JSON" | python3 -c "import sys,json,re; cards=json.load(sys.stdin); nums=[int(m.group(1)) for c in cards for m in [re.search(r'TRELLO-(\d+)',c.get('name',''))] if m]; print(max(nums,default=0)+1)")"

            TID="TRELLO-$(printf '%03d' "$NEXT_NUM")"
            CARD_NAME="${TID} - ${PR_TITLE}"
            CARD_DESC="Auto-created by GitHub Actions.\nPR: ${PR_URL}\nRepo: ${REPO}\nPR#: ${PR_NUMBER}\n"

            CARD_ID="$(curl -sS -X POST \
              --data-urlencode "idList=${LIST_BACKLOG}" \
              --data-urlencode "name=${CARD_NAME}" \
              --data-urlencode "desc=${CARD_DESC}" \
              "https://api.trello.com/1/cards?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
              | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")"

            echo "Created Trello card: $CARD_NAME ($CARD_ID)"
          else
            echo "Found existing Trello card for PR: $CARD_ID"
          fi

          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_REVIEW_QA}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null

          echo "Moved Trello card to Review/QA."
