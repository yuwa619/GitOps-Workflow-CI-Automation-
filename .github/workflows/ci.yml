name: CI

on:
  push:
    branches:
      - main
      - "feature/**"
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review, closed]

permissions:
  contents: read

jobs:
  # ── 1. Card lifecycle on PR open / synchronize / reopen ───────────────────
  trello-in-progress:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      (
        github.event.action == 'opened' ||
        github.event.action == 'synchronize' ||
        github.event.action == 'reopened' ||
        github.event.action == 'ready_for_review'
      )
    steps:
      - name: Create card (if missing) and move to In Progress
        env:
          TRELLO_KEY:        ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN:      ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID:   ${{ secrets.TRELLO_BOARD_ID }}
          LIST_BACKLOG:      ${{ secrets.TRELLO_LIST_BACKLOG }}
          LIST_IN_PROGRESS:  ${{ secrets.TRELLO_LIST_IN_PROGRESS }}
          PR_TITLE:          ${{ github.event.pull_request.title }}
          PR_URL:            ${{ github.event.pull_request.html_url }}
          PR_NUMBER:         ${{ github.event.pull_request.number }}
          REPO:              ${{ github.repository }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "
          import os,sys,json
          pr=os.environ['PR_URL']
          cards=json.load(sys.stdin)
          print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))
          ")"

          if [ -z "$CARD_ID" ]; then
            NEXT_NUM="$(echo "$CARDS_JSON" | python3 -c "
          import sys,json,re
          cards=json.load(sys.stdin)
          nums=[int(m.group(1)) for c in cards for m in [re.search(r'TRELLO-(\d+)',c.get('name',''))] if m]
          print(max(nums,default=0)+1)
            ")"

            TID="TRELLO-$(printf '%03d' "$NEXT_NUM")"
            CARD_NAME="${TID} - ${PR_TITLE}"
            CARD_DESC="Auto-created by GitHub Actions.\nPR: ${PR_URL}\nRepo: ${REPO}\nPR#: ${PR_NUMBER}"

            # Create in Backlog first
            CARD_ID="$(curl -sS -X POST \
              --data-urlencode "idList=${LIST_BACKLOG}" \
              --data-urlencode "name=${CARD_NAME}" \
              --data-urlencode "desc=${CARD_DESC}" \
              "https://api.trello.com/1/cards?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
              | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")"
            echo "Created Trello card: $CARD_NAME ($CARD_ID)"
          else
            echo "Found existing card: $CARD_ID"
          fi

          # Move to In Progress
          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_IN_PROGRESS}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Moved card to In Progress."

  # ── 2. Build & test ────────────────────────────────────────────────────────
  build-test:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint
        run: flake8 app.py test_app.py

      - name: Test
        run: pytest test_app.py -v

  # ── 3. CI passed → Review/QA ───────────────────────────────────────────────
  trello-review-qa:
    needs: build-test
    runs-on: ubuntu-latest
    if: >
      success() &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    steps:
      - name: Move card to Review/QA
        env:
          TRELLO_KEY:      ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN:    ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          LIST_REVIEW_QA:  ${{ secrets.TRELLO_LIST_REVIEW_QA }}
          PR_URL:          ${{ github.event.pull_request.html_url }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "
          import os,sys,json
          pr=os.environ['PR_URL']
          cards=json.load(sys.stdin)
          print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))
          ")"

          if [ -z "$CARD_ID" ]; then
            echo "No card found for this PR — skipping."
            exit 0
          fi

          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_REVIEW_QA}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Moved card to Review/QA."

  # ── 4. CI failed → back to In Progress ────────────────────────────────────
  trello-ci-failed:
    needs: build-test
    runs-on: ubuntu-latest
    if: >
      failure() &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    steps:
      - name: Move card back to In Progress on CI failure
        env:
          TRELLO_KEY:       ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN:     ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID:  ${{ secrets.TRELLO_BOARD_ID }}
          LIST_IN_PROGRESS: ${{ secrets.TRELLO_LIST_IN_PROGRESS }}
          PR_URL:           ${{ github.event.pull_request.html_url }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "
          import os,sys,json
          pr=os.environ['PR_URL']
          cards=json.load(sys.stdin)
          print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))
          ")"

          if [ -z "$CARD_ID" ]; then
            echo "No card found for this PR — skipping."
            exit 0
          fi

          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_IN_PROGRESS}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Moved card back to In Progress (CI failed)."

  # ── 5. PR merged → Done + green label + merge comment ─────────────────────
  trello-done:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    steps:
      - name: Move card to Done, add green label and merge comment
        env:
          TRELLO_KEY:      ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN:    ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          LIST_DONE:       ${{ secrets.TRELLO_LIST_DONE }}
          PR_URL:          ${{ github.event.pull_request.html_url }}
          PR_NUMBER:       ${{ github.event.pull_request.number }}
          PR_TITLE:        ${{ github.event.pull_request.title }}
          MERGED_BY:       ${{ github.event.pull_request.merged_by.login }}
          REPO:            ${{ github.repository }}
        run: |
          set -euo pipefail

          CARDS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards?fields=name,desc&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          CARD_ID="$(echo "$CARDS_JSON" | python3 -c "
          import os,sys,json
          pr=os.environ['PR_URL']
          cards=json.load(sys.stdin)
          print(next((c['id'] for c in cards if pr in (c.get('desc') or '')), ''))
          ")"

          if [ -z "$CARD_ID" ]; then
            echo "No card found for this PR — skipping."
            exit 0
          fi

          # 1. Move card to Done
          curl -sS -X PUT \
            "https://api.trello.com/1/cards/${CARD_ID}?idList=${LIST_DONE}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Moved card to Done."

          # 2. Find or create a green label named "✅ Completed" on the board
          LABELS_JSON="$(curl -sS \
            "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/labels?fields=id,name,color&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}")"

          LABEL_ID="$(echo "$LABELS_JSON" | python3 -c "
          import sys,json
          labels=json.load(sys.stdin)
          print(next((l['id'] for l in labels if l.get('color')=='green' and l.get('name')=='✅ Completed'), ''))
          ")"

          if [ -z "$LABEL_ID" ]; then
            LABEL_ID="$(curl -sS -X POST \
              --data-urlencode "name=✅ Completed" \
              --data-urlencode "color=green" \
              --data-urlencode "idBoard=${TRELLO_BOARD_ID}" \
              "https://api.trello.com/1/labels?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
              | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")"
            echo "Created green label: $LABEL_ID"
          else
            echo "Found existing green label: $LABEL_ID"
          fi

          # 3. Apply the green label to the card
          curl -sS -X POST \
            "https://api.trello.com/1/cards/${CARD_ID}/idLabels?value=${LABEL_ID}&key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Applied green label to card."

          # 4. Post a merge comment on the card
          MERGE_DATE="$(date -u '+%Y-%m-%d %H:%M UTC')"
          COMMENT="✅ *Merged on ${MERGE_DATE}*\n\n**PR:** [#${PR_NUMBER} - ${PR_TITLE}](${PR_URL})\n**Merged by:** @${MERGED_BY}\n**Repo:** ${REPO}"

          curl -sS -X POST \
            --data-urlencode "text=${COMMENT}" \
            "https://api.trello.com/1/cards/${CARD_ID}/actions/comments?key=${TRELLO_KEY}&token=${TRELLO_TOKEN}" \
            > /dev/null
          echo "Posted merge comment on card."
